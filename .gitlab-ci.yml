---
image: maven:3.6.1-jdk-8-alpine

stages:
  - build
  - deploy

variables:
  BUILD_NUMBER: ${CI_COMMIT_REF_SLUG}-${CI_PIPELINE_ID}

build:
  stage: build
  variables:
    MAVEN_OPTS: -Dmaven.repo.local=${HOME}/.m2/repository
  cache:
    key: ${CI_JOB_NAME}
    paths:
      - ${HOME}/.m2/repository
  script: mvn verify -Dbuild.number=${BUILD_NUMBER}
  artifacts:
    paths:
      - target/rpki-ta-0-*-${BUILD_NUMBER}-dist.tar.gz
      - src/main/scripts/*

.deploy: &deploy
  stage: deploy
  image: docker-registry.ripe.net/swe/gitlab-ci/debian-deployenv
  before_script:
    - chmod 400 ${SSH_KEY}
    - chmod +x src/main/scripts/*.sh
    - mv target/rpki-ta-0-*-${BUILD_NUMBER}-dist.tar.gz .
  script:
    # Print public key
    - ssh-keygen -y -l -f ${SSH_KEY}
    - >
      src/main/scripts/deploy.sh ${SSH_KEY}
      rpki-ta-0-*-${BUILD_NUMBER}-dist.tar.gz ${NODES}
  when: manual

localcert:
  <<: *deploy
  variables:
    NODES: "localcert-1.rpki.ripe.net"
  environment:
    name: localcert

prepdev:
  <<: *deploy
  variables:
    NODES: "core-1.rpki.prepdev.ripe.net"
  environment:
    name: prepdev
